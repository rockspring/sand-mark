目录

阅读的代码最后一个提交点是master分支的33695781f9ce2599d18f45de6a465eaefe7d71f4

# flink-runtime

## 文件系统实现

目前有LocalFileSystem、HadoopFileSystem、MapRFileSystem。LocalFileSystem文件系统是直接实现的，HadoopFileSystem、MapRFileSystem是以桥接的方式连接远程的文件系统。

## AbstractKeyedStateBackend

KeyedStateBackend、InternalKeyContext

Snapshotable

KeyGroupsStateHandle、StreamStateHandle、StateObject

AbstractKeyedStateBackend、HeapKeyedStateBackend、RocksDBKeyedStateBackend

# flink-core

## 文件系统

### 文件系统抽象接口

org.apache.flink.core.fs.FileSystem

Flink使用的所有文件系统的抽象基类。这个抽象的目的是暴露公共的定义良好的文件访问接口。flink的容错机制通过文件系统抽象接口保存状态和系统恢复用的数据。内置连接器，如文件源和文件槽通过文件系统抽象接口读写数据。

#### 更新文件内容

有很多文件系统即不支持覆盖式写入已经存在内容的文件，又不支持在前面这种场景下的一致性可见性。Flink文件系统不支持往已经存在的文件追加内容，不支持在输出流中进行寻址，这样防止先前写入的内容被覆盖。

#### 覆盖文件

覆盖文件通常是可能的。通过删除一个被覆盖的文件，然后创建一个新文件。然后，一些文件系统不能做到这些修改对所有访问这个文件的受众同步可见，一些机器看了最新的文件，另一些机器看到了旧的文件。Amazon S3就是一个例子，只保证最终一致性。

为了避免一致性问题，flink的失败、恢复机制严格避免对同一个文件写入多次。

#### 线程安全性

文件系统实现必须线程安全。同一个文件系统实例被flink的多个线程共享，必须能够并发地创建输入/输出流、列出文件元数据。

FSDataOutputStream和FSDataOutputStream实例是非线程安全安全的，并且不保证跨写入-读取线程的可见性，因为很多操作没有创建内存屏障。

#### 文件流安全保障（Streams Safety Net）

当应用代码通过FileSystem#get(URI)或Path#getFileSystem()获取一个文件系统时，FileSystem创建一个安全保障网。安全保障网确保当应用程序结束、取消或失败时，从文件系统创建的所有文件流被正确地关闭。这种方式下，任务线程不会泄露连接。

org.apache.flink.core.fs.FileSystemSafetyNet#wrapWithSafetyNetWhenActivated

### FileSystemSafetyNet

FileSystemSafetyNet、AbstractCloseableRegistry、SafetyNetCloseableRegistry、SafetyNetCloseableRegistry.PhantomDelegatingCloseableRef、SafetyNetCloseableRegistry.CloseableReaperThread、WrappingProxyCloseable

注册实现了Closeable接口的实例到AbstractCloseableRegistry注册表，当AbstractCloseableRegistry关闭时，所有注册在内的Closeable实例都被关闭。AbstractCloseableRegistry是线程安全的。AbstractCloseableRegistry有两个抽象方法注册（doRegister）和注销（doUnRegister），由具体实现的子类实现。

SafetyNetCloseableRegistry.CloseableReaperThread中有ReferenceQueue虚引用队列。

SafetyNetCloseableRegistry初始化时，启动一个SafetyNetCloseableRegistry.CloseableReaperThread线程。

#### SafetyNetCloseableRegistry

AbstractCloseableRegistry、CloseableRegistry、SafetyNetCloseableRegistry

SafetyNetCloseableRegistry注册表注册WrappingProxyCloseable，当代理对象受到GC的管控时，SafetyNetCloseableRegistry关闭未关闭的Closeable。

虚引用（幻引用）是用于跟踪包装了Closeable的WrappingProxy什么时候被GC了。我们要确保WrappingProxy包装的Closeable被正确地关闭避免资源泄露。

使用场景：

org.apache.flink.core.fs.ClosingFSDataInputStream#wrapSafe(org.apache.flink.core.fs.FSDataInputStream, org.apache.flink.core.fs.SafetyNetCloseableRegistry, java.lang.String)

org.apache.flink.core.fs.ClosingFSDataOutputStream#wrapSafe(org.apache.flink.core.fs.FSDataOutputStream, org.apache.flink.core.fs.SafetyNetCloseableRegistry, java.lang.String)

org.apache.flink.runtime.state.DefaultOperatorStateBackend#restore

org.apache.flink.runtime.state.DefaultOperatorStateBackend#snapshot

org.apache.flink.runtime.state.StateInitializationContextImpl.AbstractStateStreamIterator#openCurrentStream

org.apache.flink.runtime.state.StateSnapshotContextSynchronousImpl#openAndRegisterNewStream

org.apache.flink.runtime.state.heap.HeapKeyedStateBackend#restorePartitionedState

org.apache.flink.runtime.state.heap.HeapKeyedStateBackend#snapshot

org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend.RocksDBSnapshotOperation#openCheckpointStream

org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend.RocksDBRestoreOperation#restoreKeyGroupsInStateHandle

org.apache.flink.streaming.api.operators.AbstractStreamOperator#restoreStreamCheckpointed

org.apache.flink.streaming.api.operators.AbstractStreamOperator#snapshotLegacyOperatorState

org.apache.flink.streaming.runtime.tasks.StreamTask#createKeyedStateBackend

org.apache.flink.streaming.runtime.tasks.StreamTask#createOperatorStateBackend

org.apache.flink.streaming.runtime.tasks.StreamTask.CheckpointingOperation#runAsyncCheckpointingAndAcknowledge


单元测试：

org.apache.flink.core.fs.SafetyNetCloseableRegistryTest#testClose

org.apache.flink.streaming.runtime.tasks.StreamTaskTest.CancelFailingTask#run

org.apache.flink.streaming.util.AbstractStreamOperatorTestHarness#AbstractStreamOperatorTestHarness(org.apache.flink.streaming.api.operators.StreamOperator<OUT>, int, int, int, org.apache.flink.runtime.execution.Environment)

## 输入输出流包装代理

FSDataInputStreamWrapper、FSDataInputStream

FSDataInputStream继承了InputStream，增加了seek和getPos功能。

ClosingFSDataInputStream

ClosingFSDataInputStream使用SafetyNetCloseableRegistry实现一个安全网防止数据流未关闭。ClosingFSDataInputStream不能直接构造，只能通过静态方法org.apache.flink.core.fs.ClosingFSDataInputStream#wrapSafe(org.apache.flink.core.fs.FSDataInputStream, org.apache.flink.core.fs.SafetyNetCloseableRegistry, java.lang.String)创建一个ClosingFSDataInputStream。


### 文件系统代理

SafetyNetWrapperFileSystem继承了FileSystem，它是实现了WrappingProxy接口的文件系统代理。

### 文件系统使用入口

org.apache.flink.core.fs.FileSystem#getUnguardedFileSystem，仅为内部使用，这个方法创建的文件系统没有安全网。

org.apache.flink.core.fs.FileSystem#get，公开API，这个方法创建的文件系统有安全网。



## GenericDataSourceBase

## org.apache.flink.runtime.operators.DataSourceTask

org.apache.flink.runtime.jobgraph.tasks.AbstractInvokable

## DataSource

org.apache.flink.api.java.operators.DataSource#translateToDataFlow

org.apache.flink.api.java.operators.OperatorTranslation#translate(org.apache.flink.api.java.DataSet<T>)

org.apache.flink.api.java.operators.OperatorTranslation#translateToPlan

org.apache.flink.api.java.ExecutionEnvironment#createProgramPlan(java.lang.String, boolean)

org.apache.flink.api.java.LocalEnvironment#execute


## 触发job执行

应用程序调用如下方法

org.apache.flink.api.java.RemoteEnvironment#execute

org.apache.flink.client.RemoteExecutor#executePlan

org.apache.flink.client.RemoteExecutor#executePlanWithJars

org.apache.flink.client.program.ClusterClient#run(org.apache.flink.client.program.JobWithJars, int)

org.apache.flink.client.program.ClusterClient#run(org.apache.flink.client.program.JobWithJars, int, org.apache.flink.runtime.jobgraph.SavepointRestoreSettings)

org.apache.flink.client.program.ClusterClient#getOptimizedPlan(org.apache.flink.optimizer.Optimizer, org.apache.flink.client.program.JobWithJars, int)

org.apache.flink.client.program.ClusterClient#getOptimizedPlan(org.apache.flink.optimizer.Optimizer, org.apache.flink.api.common.Plan, int)

org.apache.flink.optimizer.Optimizer#compile(org.apache.flink.api.common.Plan)

org.apache.flink.optimizer.Optimizer#compile(org.apache.flink.api.common.Plan, org.apache.flink.optimizer.postpass.OptimizerPostPass)

org.apache.flink.optimizer.traversals.PlanFinalizer#createFinalPlan

org.apache.flink.optimizer.plan.OptimizedPlan#OptimizedPlan


提交执行

org.apache.flink.client.program.ClusterClient#run(org.apache.flink.optimizer.plan.FlinkPlan, java.util.List<java.net.URL>, java.util.List<java.net.URL>, java.lang.ClassLoader, org.apache.flink.runtime.jobgraph.SavepointRestoreSettings)

org.apache.flink.client.program.ClusterClient#getJobGraph(org.apache.flink.optimizer.plan.FlinkPlan, java.util.List<java.net.URL>, java.util.List<java.net.URL>, org.apache.flink.runtime.jobgraph.SavepointRestoreSettings)

org.apache.flink.optimizer.plantranslate.JobGraphGenerator#compileJobGraph(org.apache.flink.optimizer.plan.OptimizedPlan)

org.apache.flink.optimizer.plantranslate.JobGraphGenerator#compileJobGraph(org.apache.flink.optimizer.plan.OptimizedPlan, org.apache.flink.api.common.JobID)

org.apache.flink.runtime.jobgraph.JobGraph#JobGraph(org.apache.flink.api.common.JobID, java.lang.String)

org.apache.flink.client.program.StandaloneClusterClient#submitJob

org.apache.flink.client.program.ClusterClient#runDetached

org.apache.flink.runtime.client.JobClient#submitJobDetached

org.apache.flink.runtime.messages.JobManagerMessages.SubmitJob

org.apache.flink.runtime.instance.AkkaActorGateway#ask


提交到yarn集群

org.apache.flink.yarn.YarnClusterClientV2#submitJob

org.apache.hadoop.yarn.client.api.YarnClient#createApplication

org.apache.flink.yarn.AbstractYarnClusterDescriptor#startAppMaster


## Plan

这是前端模块中表示计算的方式。

使用org.apache.flink.api.java.operators.OperatorTranslation翻译job创建API创建的job。

org.apache.flink.api.java.RemoteEnvironment#execute

org.apache.flink.api.java.ExecutionEnvironment#createProgramPlan(java.lang.String)

org.apache.flink.api.java.ExecutionEnvironment#createProgramPlan(java.lang.String, boolean)

转换成plan是从sink开始的

sink是应用程序自己设置的，设置流程如下

org.apache.flink.api.java.DataSet#output

org.apache.flink.api.java.ExecutionEnvironment#registerDataSink

org.apache.flink.api.java.DataSet
org.apache.flink.api.java.operators.Operator
org.apache.flink.api.java.operators.DataSource

org.apache.flink.api.java.DataSet
org.apache.flink.api.java.operators.Operator
org.apache.flink.api.java.operators.SingleInputOperator
org.apache.flink.api.java.operators.AggregateOperator
org.apache.flink.api.java.operators.DistinctOperator
org.apache.flink.api.java.operators.FilterOperator
org.apache.flink.api.java.operators.FlatMapOperator
org.apache.flink.api.java.operators.GroupCombineOperator
org.apache.flink.api.java.operators.GroupReduceOperator
org.apache.flink.api.java.operators.IterativeDataSet
org.apache.flink.api.java.operators.MapOperator
org.apache.flink.api.java.operators.MapPartitionOperator
org.apache.flink.api.java.operators.PartitionOperator
org.apache.flink.api.java.operators.ProjectOperator
org.apache.flink.api.java.operators.ReduceOperator
org.apache.flink.api.scala.operators.ScalaAggregateOperator
org.apache.flink.api.java.operators.SingleInputUdfOperator
org.apache.flink.api.java.operators.SortPartitionOperator

org.apache.flink.api.java.DataSet
org.apache.flink.api.java.operators.Operator
org.apache.flink.api.java.operators.TwoInputOperator
org.apache.flink.api.java.operators.CoGroupOperator
org.apache.flink.api.java.operators.CoGroupRawOperator
org.apache.flink.api.java.operators.CrossOperator
org.apache.flink.api.java.operators.CrossOperator.DefaultCross
org.apache.flink.api.java.operators.JoinOperator.DefaultJoin
org.apache.flink.api.java.operators.JoinOperator.EquiJoin
org.apache.flink.api.java.operators.JoinOperator
org.apache.flink.api.java.operators.CrossOperator.ProjectCross
org.apache.flink.api.java.operators.JoinOperator.ProjectJoin
org.apache.flink.api.java.operators.TwoInputUdfOperator
org.apache.flink.api.java.operators.UnionOperator

org.apache.flink.api.java.DataSet
org.apache.flink.api.java.operators.BulkIterationResultSet

org.apache.flink.api.java.DataSet
org.apache.flink.api.java.operators.DeltaIterationResultSet

org.apache.flink.api.java.DataSet
org.apache.flink.api.java.operators.DeltaIteration.SolutionSetPlaceHolder

org.apache.flink.api.java.DataSet
org.apache.flink.api.java.operators.DeltaIteration.WorksetPlaceHolder


org.apache.flink.util.Visitable
org.apache.flink.api.common.operators.Operator
org.apache.flink.api.common.operators.GenericDataSinkBase

org.apache.flink.api.common.operators.AbstractUdfOperator


org.apache.flink.api.common.operators.IterationOperator
org.apache.flink.api.common.operators.AbstractUdfOperator
org.apache.flink.api.common.operators.SingleInputOperator
org.apache.flink.api.common.operators.base.BulkIterationBase

org.apache.flink.api.common.operators.base.FilterOperatorBase
org.apache.flink.api.java.operators.translation.PlanFilterOperator

org.apache.flink.api.common.operators.base.FlatMapOperatorBase

org.apache.flink.api.common.operators.base.GroupCombineOperatorBase
org.apache.flink.api.java.operators.translation.PlanUnwrappingGroupCombineOperator

org.apache.flink.api.common.operators.base.GroupCombineOperatorBase
org.apache.flink.api.java.operators.translation.PlanUnwrappingSortedGroupCombineOperator

org.apache.flink.api.common.operators.base.GroupReduceOperatorBase
org.apache.flink.api.java.operators.translation.PlanUnwrappingReduceGroupOperator

org.apache.flink.api.common.operators.base.GroupReduceOperatorBase
org.apache.flink.api.java.operators.translation.PlanUnwrappingReduceOperator

org.apache.flink.api.common.operators.base.GroupReduceOperatorBase
org.apache.flink.api.java.operators.translation.PlanUnwrappingSortedReduceGroupOperator

org.apache.flink.api.common.operators.base.MapOperatorBase
org.apache.flink.api.java.operators.translation.PlanProjectOperator

org.apache.flink.api.common.operators.base.MapPartitionOperatorBase

org.apache.flink.optimizer.util.NoOpUnaryUdfOp

org.apache.flink.api.common.operators.base.PartitionOperatorBase

org.apache.flink.api.common.operators.base.SortPartitionOperatorBase

## JobGraph

JobGraph代表flink数据流程序，JobManager接收的底层表示。

org.apache.flink.util.AbstractID
org.apache.flink.runtime.jobgraph.JobVertexID

org.apache.flink.runtime.jobgraph.JobVertex

org.apache.flink.runtime.jobgraph.JobEdge

org.apache.flink.runtime.jobgraph.DistributionPattern

org.apache.flink.runtime.jobgraph.IntermediateDataSet

org.apache.flink.runtime.jobmanager.scheduler.SlotSharingGroup

org.apache.flink.runtime.jobmanager.scheduler.CoLocationGroup

org.apache.flink.core.io.InputSplitSource

org.apache.flink.api.common.operators.ResourceSpec

## JobMaster

负责单个JobGraph的执行。

org.apache.flink.runtime.rpc.RpcGateway

org.apache.flink.runtime.rpc.RpcEndpoint
org.apache.flink.runtime.jobmaster.JobMaster


在哪里启动：

yarn模式：

org.apache.flink.yarn.AbstractYarnFlinkApplicationMasterRunner#run

org.apache.flink.yarn.YarnFlinkApplicationMasterRunner#runApplicationMaster

org.apache.flink.yarn.YarnFlinkApplicationMasterRunner#createJobManagerRunner

org.apache.flink.runtime.jobmaster.JobManagerRunner#JobManagerRunner(org.apache.flink.runtime.clusterframework.types.ResourceID, org.apache.flink.runtime.jobgraph.JobGraph, org.apache.flink.configuration.Configuration, org.apache.flink.runtime.rpc.RpcService, org.apache.flink.runtime.highavailability.HighAvailabilityServices, org.apache.flink.runtime.heartbeat.HeartbeatServices, org.apache.flink.runtime.jobmaster.JobManagerServices, org.apache.flink.runtime.metrics.MetricRegistry, org.apache.flink.runtime.jobmanager.OnCompletionActions, org.apache.flink.runtime.rpc.FatalErrorHandler)

本地集群模式：
org.apache.flink.runtime.minicluster.MiniCluster#runDetached
org.apache.flink.runtime.minicluster.MiniClusterJobDispatcher#runDetached
org.apache.flink.runtime.minicluster.MiniClusterJobDispatcher#startJobRunners

org.apache.flink.streaming.api.environment.Flip6LocalStreamEnvironment#execute
org.apache.flink.runtime.minicluster.MiniCluster#runJobBlocking
org.apache.flink.runtime.minicluster.MiniClusterJobDispatcher#runJobBlocking
org.apache.flink.runtime.minicluster.MiniClusterJobDispatcher#startJobRunners

## LeaderElectionService

org.apache.flink.runtime.leaderelection.StandaloneLeaderElectionService
org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionService

## LeaderRetrievalService

org.apache.flink.runtime.leaderretrieval.LeaderRetrievalService
org.apache.flink.runtime.leaderretrieval.StandaloneLeaderRetrievalService
org.apache.flink.runtime.leaderretrieval.ZooKeeperLeaderRetrievalService

## MemoryManager

org.apache.flink.runtime.memory.MemoryManager.MemoryPool

org.apache.flink.core.memory.MemoryType

org.apache.flink.core.memory.MemorySegment
org.apache.flink.core.memory.HeapMemorySegment
org.apache.flink.core.memory.HybridMemorySegment

org.apache.flink.core.memory.DataInputView
org.apache.flink.runtime.memory.AbstractPagedInputView
org.apache.flink.runtime.io.disk.iomanager.ChannelReaderInputView

org.apache.flink.core.memory.DataOutputView
org.apache.flink.runtime.memory.AbstractPagedOutputView
org.apache.flink.runtime.io.disk.iomanager.ChannelWriterOutputView

org.apache.flink.core.memory.MemorySegmentSource
org.apache.flink.runtime.memory.ListMemorySegmentSource

## messages

actor之间发送的消息，如JobManager和TaskManager之间发送的。

org.apache.flink.runtime.messages.MessageDecorator
org.apache.flink.runtime.messages.LeaderSessionMessageDecorator

org.apache.flink.runtime.messages.Acknowledge

org.apache.flink.runtime.messages.webmonitor包含了获取JobManager状态的消息。

org.apache.flink.runtime.messages.checkpoint包含了JobManager和TaskManager协调检查点快照的消息。

## Metric

org.apache.flink.runtime.metrics.MetricRegistry，跟踪所有注册的Metric，连接MetricGroup和MetricReporters。

## Slot

org.apache.flink.runtime.instance.Slot
org.apache.flink.runtime.instance.SimpleSlot
org.apache.flink.runtime.instance.SharedSlot

org.apache.flink.runtime.jobmanager.slots.SlotOwner
org.apache.flink.runtime.instance.Instance

## Task

AbstractInvokable是TaskManager能够执行的任务的抽象基类。

org.apache.flink.runtime.jobgraph.tasks.AbstractInvokable
org.apache.flink.runtime.operators.DataSourceTask

org.apache.flink.runtime.operators.TaskContext
org.apache.flink.runtime.jobgraph.tasks.AbstractInvokable
org.apache.flink.runtime.operators.BatchTask

org.apache.flink.runtime.iterative.task.Terminable
org.apache.flink.runtime.operators.BatchTask
org.apache.flink.runtime.operators.TaskContext
org.apache.flink.runtime.jobgraph.tasks.AbstractInvokable
org.apache.flink.runtime.operators.BatchTask
org.apache.flink.runtime.iterative.task.AbstractIterativeTask
org.apache.flink.runtime.iterative.task.IterationHeadTask
org.apache.flink.runtime.iterative.task.IterationIntermediateTask
org.apache.flink.runtime.iterative.task.IterationTailTask

任务包含driver，借助driver来执行。

在任务中单独运行或作为主driver运行。Driver实现批操作处理的具体代码，如map()、reduce()、join()、coGroup()具体实现。

org.apache.flink.runtime.operators.MapDriver

### DataSourceTask

由task manager执行。这个任务读取数据，然后使用InputFormat从输入数据创建记录

## Environment

org.apache.flink.runtime.execution.Environment
org.apache.flink.runtime.taskmanager.RuntimeEnvironment

## QueryableStateClient

org.apache.flink.runtime.query.QueryableStateClient

## ResourceManager

org.apache.flink.runtime.resourcemanager.StandaloneResourceManager
org.apache.flink.yarn.YarnResourceManager

## RpcService

org.apache.flink.runtime.rpc.akka.AkkaRpcService

org.apache.flink.runtime.rpc.RpcEndpoint

org.apache.flink.runtime.rpc.RpcEndpoint#RpcEndpoint启动RPC服务器。



## TaskExecutor


## taskmanager

org.apache.flink.runtime.taskmanager.Task

## 工具

### OperatingSystem

枚举JVM运行的操作系统。Linux、Windows、Mac、FreeBSD、sunos、solaris。系统运行时通过系统属性”os.name”指定。

### Preconditions

包含一组用于验证输入的静态工具方法。

### IOUtils

I/O相关的工具类。

### WrappingProxy

代理接口

### WrappingProxyUtil

WrappingProxy工具。剥去代理层，得到被代理的对象。

### MathUtils

