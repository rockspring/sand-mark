# 索引构建过程

## 往索引添加文档调用方法链路

```
at org.apache.lucene.index.DefaultIndexingChain.processField(DefaultIndexingChain.java:462)
at org.apache.lucene.index.DefaultIndexingChain.processDocument(DefaultIndexingChain.java:392)
at org.apache.lucene.index.DocumentsWriterPerThread.updateDocument(DocumentsWriterPerThread.java:239)
at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:481)
at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1717)
at org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1462)
```

添加一种索引类型，如空间点索引，在org.apache.lucene.index.DefaultIndexingChain.processField(DefaultIndexingChain.java:462)方法里添加相应的处理逻辑。

如下就是处理空间点索引的逻辑。

```
if (fieldType.pointDimensionCount() != 0) {
  if (fp == null) {
    fp = getOrAddField(fieldName, fieldType, false);
  }
  indexPoint(fp, field);
}
```

org.apache.lucene.index.DefaultIndexingChain.PerField

每个字段一个实例。如下代码申明一个PointValuesWriter pointValuesWriter字段，持有处理空间点的写入器。在at org.apache.lucene.index.DefaultIndexingChain.indexPoint(DefaultIndexingChain.java:512)代码中创建一个PointValuesWriter实例，设置到PerField的字段pointValuesWriter。

```
// Non-null if this field ever had points in this segment:
PointValuesWriter pointValuesWriter;
```

org.apache.lucene.index.PointValuesWriter是一个缓冲区。待一个段内的所有文档添加完了之后，调用其flush方法，创建索引结构，写入磁盘。

## org.apache.lucene.index.DefaultIndexingChain#indexPoint

往空间点索引加入字段的代码执行起点。


## 文档添加完之后的结束方法调用链路

```
at org.apache.lucene.index.PointValuesWriter.flush(PointValuesWriter.java:73)
at org.apache.lucene.index.DefaultIndexingChain.writePoints(DefaultIndexingChain.java:202)
at org.apache.lucene.index.DefaultIndexingChain.flush(DefaultIndexingChain.java:137)
at org.apache.lucene.index.DocumentsWriterPerThread.flush(DocumentsWriterPerThread.java:451)
at org.apache.lucene.index.DocumentsWriter.doFlush(DocumentsWriter.java:542)
at org.apache.lucene.index.DocumentsWriter.flushAllThreads(DocumentsWriter.java:658)
at org.apache.lucene.index.IndexWriter.doFlush(IndexWriter.java:3570)
- locked <0x968> (a java.lang.Object)
at org.apache.lucene.index.IndexWriter.flush(IndexWriter.java:3545)
at org.apache.lucene.index.IndexWriter.forceMerge(IndexWriter.java:2039)
at org.apache.lucene.index.IndexWriter.forceMerge(IndexWriter.java:2019)
at org.apache.lucene.codecs.lucene60.TestLucene60PointsFormat.testEstimatePointCount2Dims(TestLucene60PointsFormat.java:215)
```


## org.apache.lucene.index.DefaultIndexingChain#flush

针对空间索引类型，添加了如下代码

```
t0 = System.nanoTime();
writePoints(state, sortMap);
if (docState.infoStream.isEnabled("IW")) {
  docState.infoStream.message("IW", ((System.nanoTime()-t0)/1000000) + " msec to write points");
}
```

## org.apache.lucene.index.DefaultIndexingChain#writePoints

实现了空间索引的写入。

## org.apache.lucene.index.PointValuesWriter#flush(SegmentWriteState state, Sorter.DocMap sortMap, PointsWriter writer) throws IOException)

将PointValuesWriter缓存的文档数据使用PointsWriter生成一个索引结构，写入到磁盘。

## 段合并过程

```
at org.apache.lucene.util.bkd.BKDWriter.build(BKDWriter.java:1630)
at org.apache.lucene.util.bkd.BKDWriter.finish(BKDWriter.java:1008)
at org.apache.lucene.codecs.lucene60.Lucene60PointsWriter.writeField(Lucene60PointsWriter.java:130)
at org.apache.lucene.codecs.PointsWriter.mergeOneField(PointsWriter.java:62)
at org.apache.lucene.codecs.lucene60.Lucene60PointsWriter.merge(Lucene60PointsWriter.java:223)
at org.apache.lucene.index.SegmentMerger.mergePoints(SegmentMerger.java:187)
at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:136)
at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4392)
at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:4032)
at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:624)
at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:661)
```

### 段合并涉及的方法详解

```
private void build(int nodeID, int leafNodeOffset,
                     PathSlice[] slices,
                     LongBitSet ordBitSet,
                     IndexOutput out,
                     byte[] minPackedValue, byte[] maxPackedValue,
                     int[] parentSplits,
                     byte[] splitPackedValues,
                     long[] leafBlockFPs,
                     List<Closeable> toCloseHeroically) throws IOException
```


## 开放给Lucene索引层的接口

### 索引构建

```
org.apache.lucene.codecs.lucene60.Lucene60PointsWriter#writeField(FieldInfo fieldInfo, PointsReader reader) throws IOException
```

写入的时候空间点数据先写入到缓冲器PointValuesWriter。

### 索引合并

```
org.apache.lucene.codecs.lucene60.Lucene60PointsWriter#merge(MergeState mergeState) throws IOException
```

## 索引读取

打开索引文件

初始化类的时候

```
at org.apache.lucene.index.SegmentCoreReaders.<init>(SegmentCoreReaders.java:138)
at org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:78)
at org.apache.lucene.index.ReadersAndUpdates.getReader(ReadersAndUpdates.java:208)
- locked <0xb9c> (a org.apache.lucene.index.ReadersAndUpdates)
at org.apache.lucene.index.ReadersAndUpdates.getReadOnlyClone(ReadersAndUpdates.java:258)
at org.apache.lucene.index.StandardDirectoryReader.open(StandardDirectoryReader.java:105)
at org.apache.lucene.index.IndexWriter.getReader(IndexWriter.java:490)
- locked <0xc3a> (a java.lang.Object)
- locked <0x794> (a org.apache.lucene.index.IndexWriter)
at org.apache.lucene.index.DirectoryReader.open(DirectoryReader.java:103)
at org.apache.lucene.index.DirectoryReader.open(DirectoryReader.java:79)
at org.apache.lucene.codecs.lucene60.TestLucene60PointsFormat.testEstimatePointCount2Dims(TestLucene60PointsFormat.java:216)
```

```
if (coreFieldInfos.hasPointValues()) {
	pointsReader = codec.pointsFormat().fieldsReader(segmentReadState);
} else {
	pointsReader = null;
}
```

打开的索引在哪里使用呢？

```
at org.apache.lucene.index.SegmentReader.getPointsReader(SegmentReader.java:246)
at org.apache.lucene.index.CodecReader.getPointValues(CodecReader.java:203)
at org.apache.lucene.codecs.lucene60.TestLucene60PointsFormat.testEstimatePointCount2Dims(TestLucene60PointsFormat.java:219)
```

```
@Override
public PointsReader getPointsReader() {
	ensureOpen();
	return core.pointsReader;
}
```

kd树对外提供了两个接口供外部使用

估计数量

org.apache.lucene.util.bkd.BKDReader#estimatePointCount(org.apache.lucene.index.PointValues.IntersectVisitor)

```
at org.apache.lucene.util.bkd.BKDReader.estimatePointCount(BKDReader.java:527)
at org.apache.lucene.codecs.lucene60.TestLucene60PointsFormat.testEstimatePointCount2Dims(TestLucene60PointsFormat.java:230)
```

用访问者模式遍历kd树

org.apache.lucene.util.bkd.BKDReader#intersect(org.apache.lucene.index.PointValues.IntersectVisitor)

org.apache.lucene.search.PointRangeQuery#createWeight#org.apache.lucene.search.ConstantScoreWeight#scorerSupplier

org.apache.lucene.search.PointInSetQuery#createWeight#org.apache.lucene.search.ConstantScoreWeight#scorer


```
at org.apache.lucene.index.SegmentReader.getPointsReader(SegmentReader.java:246)
at org.apache.lucene.index.CodecReader.getPointValues(CodecReader.java:203)
at org.apache.lucene.search.PointInSetQuery$1.scorer(PointInSetQuery.java:119)
at org.apache.lucene.search.Weight.bulkScorer(Weight.java:147)
at org.apache.lucene.search.LRUQueryCache$CachingWrapperWeight.cache(LRUQueryCache.java:705)
at org.apache.lucene.search.LRUQueryCache$CachingWrapperWeight.bulkScorer(LRUQueryCache.java:824)
at org.apache.lucene.search.AssertingWeight.bulkScorer(AssertingWeight.java:79)
at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:655)
at org.apache.lucene.search.AssertingIndexSearcher.search(AssertingIndexSearcher.java:72)
at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:462)
at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:581)
at org.apache.lucene.search.IndexSearcher.count(IndexSearcher.java:397)
at org.apache.lucene.search.TestPointQueries.testBasicMultiValuedPointInSetQuery(TestPointQueries.java:1645)
```


```
at org.apache.lucene.index.AssertingLeafReader$AssertingPointValues.intersect(AssertingLeafReader.java:898)
at org.apache.lucene.search.PointInSetQuery$1.scorer(PointInSetQuery.java:137)
at org.apache.lucene.search.Weight.bulkScorer(Weight.java:147)
at org.apache.lucene.search.LRUQueryCache$CachingWrapperWeight.cache(LRUQueryCache.java:705)
at org.apache.lucene.search.LRUQueryCache$CachingWrapperWeight.bulkScorer(LRUQueryCache.java:824)
at org.apache.lucene.search.AssertingWeight.bulkScorer(AssertingWeight.java:79)
at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:655)
at org.apache.lucene.search.AssertingIndexSearcher.search(AssertingIndexSearcher.java:72)
at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:462)
at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:581)
at org.apache.lucene.search.IndexSearcher.count(IndexSearcher.java:397)
at org.apache.lucene.search.TestPointQueries.testBasicMultiValuedPointInSetQuery(TestPointQueries.java:1645)
```


```
at org.apache.lucene.search.PointRangeQuery$1.scorerSupplier(PointRangeQuery.java:228)
at org.apache.lucene.search.PointRangeQuery$1.scorer(PointRangeQuery.java:318)
at org.apache.lucene.search.Weight.bulkScorer(Weight.java:147)
at org.apache.lucene.search.LRUQueryCache$CachingWrapperWeight.cache(LRUQueryCache.java:705)
at org.apache.lucene.search.LRUQueryCache$CachingWrapperWeight.bulkScorer(LRUQueryCache.java:824)
at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:655)
at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:462)
at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:581)
at org.apache.lucene.search.IndexSearcher.count(IndexSearcher.java:397)
at org.apache.lucene.search.TestPointQueries.testBasicFloats(TestPointQueries.java:149)
at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)
at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
at java.lang.reflect.Method.invoke(Method.java:498)
```

```
at org.apache.lucene.util.bkd.BKDReader.intersect(BKDReader.java:522)
at org.apache.lucene.index.AssertingLeafReader$AssertingPointValues.intersect(AssertingLeafReader.java:898)
at org.apache.lucene.search.PointRangeQuery$1$4.get(PointRangeQuery.java:293)
at org.apache.lucene.search.PointRangeQuery$1.scorer(PointRangeQuery.java:322)
at org.apache.lucene.search.Weight.bulkScorer(Weight.java:147)
at org.apache.lucene.search.LRUQueryCache$CachingWrapperWeight.cache(LRUQueryCache.java:705)
at org.apache.lucene.search.LRUQueryCache$CachingWrapperWeight.bulkScorer(LRUQueryCache.java:824)
at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:655)
at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:462)
at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:581)
at org.apache.lucene.search.IndexSearcher.count(IndexSearcher.java:397)
at org.apache.lucene.search.TestPointQueries.testBasicFloats(TestPointQueries.java:149)
at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)
at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
at java.lang.reflect.Method.invoke(Method.java:498)
```
