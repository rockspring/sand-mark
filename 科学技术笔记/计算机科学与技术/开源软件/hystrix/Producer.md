rx.internal.util.ScalarSynchronousObservable#createProducer

创建一个Producer

线程安全的SingleProducer

非线程安全的WeakSingleProducer


rx.internal.util.ScalarSynchronousObservable.JustOnSubscribe#call

给Subscriber设置一个Producer，如果订阅者Subscriber的passToSubscriber值为true，传递给它的subscriber字段指向的订阅者Subscriber。


倒数第二个订阅者，在rx.internal.operators.OperatorSubscribeOn#call里创建，他的subscriber字段传入最后一个订阅者，并且重载了方法rx.Subscriber#setProducer，创建一个匿名的Producer，重载了它的rx.Producer#request方法。如果执行request时线程未变，则直接调用委托给它的Producer，否则，创建一个任务调用委托给它的Producer，任务使用调度器调度。

最后一个订阅者的subscriber字段为null，passToSubscriber为false，Producer不再往下传递。调用rx.Producer#request方法，调用rx.internal.util.ScalarSynchronousObservable.WeakSingleProducer#request方法，在这个方法里取出值。WeakSingleProducer的request方法里调用WeakSingleProducer的actual字段指向的Subscriber的onNext方法，传给Subscriber的subscriber的onNext方法，传给Subscriber的subscriber的onNext方法（com.netflix.hystrix.AbstractCommand.ExecutionHookApplication#call里创建的subscriber），使用com.netflix.hystrix.AbstractCommand#wrapWithOnExecutionEmitHook包装一下原始值（默认包装后不变），传给Subscriber的subscriber的onNext方法（com.netflix.hystrix.AbstractCommand.DeprecatedOnRunHookApplication#call里创建的subscriber），将原始值经过com.netflix.hystrix.strategy.executionhook.HystrixCommandExecutionHook#onRunSuccess(com.netflix.hystrix.HystrixInvokable<T>, T)方法处理下（默认不变），传给Subscriber的subscriber的onNext方法（rx.observers.Subscribers#wrap里创建的subscriber），传给Subscriber的subscriber的onNext方法（rx.internal.operators.OnSubscribeDoOnEach.DoOnEachSubscriber#onNext），调用rx.internal.util.ActionObserver#onNext处理下，它调用rx.functions.Actions.EmptyAction#call(T0)处理下，传给Subscriber的subscriber的onNext方法（rx.observers.Subscribers#wrap里创建的subscriber），传给Subscriber的subscriber的onNext方法（rx.internal.operators.OperatorSubscribeOn#call里创建的Subscriber），传给Subscriber的subscriber的onNext方法（com.netflix.hystrix.AbstractCommand.HystrixObservableTimeoutOperator#call里创建的Subscriber），判断是否已经超时了，如果已经超时，则不再往下传递，原路返回，退回到rx.internal.util.ScalarSynchronousObservable.WeakSingleProducer#request方法，判定subscriber是否已经取消订阅了，如果已经取消了，往上退回，退到rx.internal.util.ScalarSynchronousObservable.JustOnSubscribe#call方法，线程最终什么也没干就退出。如果未超时，传递给一个subscriber（com.netflix.hystrix.AbstractCommand.HystrixObservableTimeoutOperator#call方法接收到的subscriber），调用其rx.internal.operators.OnSubscribeDoOnEach.DoOnEachSubscriber#onNext方法。

调用rx.internal.util.ActionObserver#onNext方法
调用com.netflix.hystrix.AbstractCommand#executeCommandAndObserve方法里创建的markEmits的rx.functions.Action1#call方法。
计算处理延时executionLatency
调用com.netflix.hystrix.ExecutionResult#addEvent(int, com.netflix.hystrix.HystrixEventType)，创建一个HystrixEventType.SUCCESS事件。
调用com.netflix.hystrix.HystrixCircuitBreaker.HystrixCircuitBreakerImpl#markSuccess方法。
传给Subscriber的subscriber的onNext方法（rx.internal.operators.OnSubscribeDoOnEach.DoOnEachSubscriber#onNext）

调用rx.internal.util.ActionObserver#onNext方法
调用rx.functions.Actions.EmptyAction#call(T0)
传给Subscriber的subscriber的onNext方法（rx.internal.operators.OperatorOnErrorResumeNextViaFunction#call里创建的subscriber）

增加produced的值，加1
传递给rx.internal.operators.OperatorOnErrorResumeNextViaFunction#call接收到的的subscriber的onNext方法

调用rx.internal.util.ActionObserver#onNext方法
调用rx.Notification#createOnNext
调用com/netflix/hystrix/AbstractCommand.java:628创建的setRequestContext的call方法。
传给Subscriber的subscriber的onNext方法（rx.internal.operators.OnSubscribeDoOnEach.DoOnEachSubscriber#onNext）

调用rx.internal.util.ActionObserver#onNext方法
调用rx.functions.Actions.EmptyAction#call(T0)
传给Subscriber的subscriber的onNext方法（rx.internal.operators.OnSubscribeDoOnEach.DoOnEachSubscriber#onNext）

调用rx.internal.util.ActionObserver#onNext方法
调用rx.functions.Actions.EmptyAction#call(T0)
传给Subscriber的subscriber的onNext方法（rx.observers.Subscribers#wrap里创建）

传给Subscriber的subscriber的onNext方法（rx.observers.Subscribers#wrap方法接收到的）

传给Subscriber的subscriber的onNext方法（rx.observers.Subscribers#wrap方法接收到的，rx.internal.operators.OnSubscribeMap.MapSubscriber#onNext）

调用com/netflix/hystrix/AbstractCommand.java:424的wrapWithAllOnNextHooks的call方法。
传递给MapSubscriber的actual的onNext方法（rx.internal.operators.OnSubscribeDoOnEach.DoOnEachSubscriber#onNext）

调用rx.internal.util.ActionObserver#onNext方法
调用rx.functions.Actions.EmptyAction#call(T0)
传给Subscriber的subscriber的onNext方法（rx.observers.Subscribers#wrap里创建）

传给Subscriber的subscriber的onNext方法（rx.observers.Subscribers#wrap方法接收到的）

调用rx.internal.util.ActionObserver#onNext方法
调用rx.functions.Actions.EmptyAction#call(T0)
传给Subscriber的subscriber的onNext方法（rx.observers.Subscribers#wrap里创建）

传给Subscriber的subscriber的onNext方法（rx.observers.Subscribers#wrap方法接收到的，rx.internal.operators.OperatorSingle.ParentSubscriber#onNext）

设置rx.internal.operators.OperatorSingle.ParentSubscriber#value值
rx.internal.operators.OperatorSingle.ParentSubscriber#isNonEmpty为true

回退到rx.internal.util.ScalarSynchronousObservable.WeakSingleProducer#request方法，调用rx.Subscriber#onCompleted方法(rx.observers.Subscribers#wrap里创建)

传给Subscriber的subscriber的onCompleted方法（rx.observers.Subscribers#wrap方法接收到的）

传给Subscriber的subscriber的onCompleted方法（rx.observers.Subscribers#wrap方法接收到的，com.netflix.hystrix.AbstractCommand.ExecutionHookApplication#call创建的）

调用com.netflix.hystrix.AbstractCommand.ExecutionHookDeprecationWrapper#onExecutionSuccess
传给Subscriber的subscriber的onCompleted方法（com.netflix.hystrix.AbstractCommand.DeprecatedOnRunHookApplication#call创建的）

传给Subscriber的subscriber的onCompleted方法（rx.observers.Subscribers#wrap方法接创建的）

传给Subscriber的subscriber的onCompleted方法（rx.observers.Subscribers#wrap方法接收到的，rx.internal.operators.OnSubscribeDoOnEach.DoOnEachSubscriber#onCompleted）

调用rx.internal.util.ActionObserver#onCompleted
调用rx.Observable#doOnTerminate创建的Action0测call方法
调用com.netflix.hystrix.AbstractCommand#handleThreadEnd方法
调用com.netflix.hystrix.HystrixThreadPool.HystrixThreadPoolDefault#markThreadCompletion方法
传给Subscriber的subscriber的onCompleted方法（rx.observers.Subscribers#wrap方法接创建的）

传给Subscriber的subscriber的onCompleted方法（rx.observers.Subscribers#wrap方法接收到的，rx.internal.operators.OperatorSubscribeOn#call里创建的）

传给Subscriber的subscriber的onCompleted方法（com.netflix.hystrix.AbstractCommand.HystrixObservableTimeoutOperator#call创建的parent）

调用com.netflix.hystrix.util.HystrixTimer.TimerReference#clear方法停止timer
传给com.netflix.hystrix.AbstractCommand.HystrixObservableTimeoutOperator#call方法接收到的child（rx.internal.operators.OnSubscribeDoOnEach.DoOnEachSubscriber#onCompleted），调用其onCompleted方法

调用rx.internal.util.ActionObserver#onCompleted
调用rx.functions.Actions.EmptyAction#call()
传给Subscriber的subscriber的onCompleted方法（rx.internal.operators.OnSubscribeDoOnEach.DoOnEachSubscriber#onCompleted）

调用rx.internal.util.ActionObserver#onCompleted
调用com/netflix/hystrix/AbstractCommand.java:589的markOnCompleted的call方法
传给Subscriber的subscriber的onCompleted方法（rx.internal.operators.OperatorOnErrorResumeNextViaFunction#call创建的parent）

标记rx.Subscriber#done为true
调用Subscriber的subscriber的onCompleted方法（rx.internal.operators.OperatorOnErrorResumeNextViaFunction#call接收到的child，rx.internal.operators.OnSubscribeDoOnEach.DoOnEachSubscriber#onCompleted）

调用rx.internal.util.ActionObserver#onCompleted
调用rx.Notification#createOnCompleted()
调用com/netflix/hystrix/AbstractCommand.java:628的setRequestContext的call方法
调用com.netflix.hystrix.AbstractCommand#setRequestContextIfNeeded
传给Subscriber的subscriber的onCompleted方法（rx.internal.operators.OnSubscribeDoOnEach.DoOnEachSubscriber#onCompleted）

调用rx.internal.util.ActionObserver#onCompleted
调用rx.functions.Actions.EmptyAction#call()
传给Subscriber的subscriber的onCompleted方法（rx.internal.operators.OnSubscribeDoOnEach.DoOnEachSubscriber#onCompleted）

调用rx.internal.util.ActionObserver#onCompleted
调用com/netflix/hystrix/AbstractCommand.java:527的singleSemaphoreRelease的call方法
调用com.netflix.hystrix.AbstractCommand.TryableSemaphoreNoOp#release方法
传给Subscriber的subscriber的onCompleted方法（rx.observers.Subscribers#wrap方法创建的）

传给Subscriber的subscriber的onCompleted方法（rx.observers.Subscribers#wrap方法接收到的）

传给Subscriber的subscriber的onCompleted方法（rx.observers.Subscribers#wrap方法接收到的，rx.internal.operators.OnSubscribeMap.MapSubscriber#onCompleted）

传给MapSubscriber的actual的onCompleted方法（rx.internal.operators.OnSubscribeDoOnEach.DoOnEachSubscriber#onCompleted）

调用rx.internal.util.ActionObserver#onCompleted
调用com/netflix/hystrix/AbstractCommand.java:369的terminateCommandCleanup的call方法
调用com.netflix.hystrix.AbstractCommand#handleCommandEnd方法
计算userThreadLatency
调用com.netflix.hystrix.ExecutionResult#markUserThreadCompletion
调用com.netflix.hystrix.HystrixCommandMetrics#markCommandDone
调用com.netflix.hystrix.metric.HystrixThreadEventStream#executionDone
调用com.netflix.hystrix.metric.HystrixCommandCompletion#from(com.netflix.hystrix.ExecutionResult, com.netflix.hystrix.HystrixCommandKey, com.netflix.hystrix.HystrixThreadPoolKey)
调用com.netflix.hystrix.metric.HystrixCommandCompletion#HystrixCommandCompletion
调用rx.subjects.PublishSubject#onNext
调用rx.subjects.PublishSubject.PublishSubjectState#onNext
调用rx.subjects.PublishSubject.PublishSubjectProducer#onNext
调用rx.internal.operators.OperatorOnBackpressureBuffer.BufferSubscriber#onNext
调用rx.internal.operators.OperatorOnBackpressureBuffer.BufferSubscriber#queue的offer方法
调用rx.internal.util.BackpressureDrainManager#drain
调用rx.internal.operators.OperatorOnBackpressureBuffer.BufferSubscriber#accept
调用rx.internal.operators.NotificationLite#accept
调用rx.internal.operators.OnSubscribeDoOnEach.DoOnEachSubscriber#onNext
rx.internal.util.ActionObserver#onNext
com.netflix.hystrix.metric.HystrixThreadEventStream#writeCommandCompletionsToShardedStreams的call方法
com.netflix.hystrix.metric.HystrixCommandCompletionStream#write
rx.subjects.SerializedSubject#onNext
rx.observers.SerializedObserver#onNext
rx.subjects.PublishSubject#onNext
rx.subjects.PublishSubject.PublishSubjectState#onNext
rx.internal.operators.OperatorPublish.PublishSubscriber#onNext
rx.internal.operators.OperatorPublish.PublishSubscriber#queue的offer方法
rx.internal.operators.OperatorPublish.PublishSubscriber#dispatch
rx.Subscriber#onNext
rx.internal.operators.OperatorWindowWithTime.ExactSubscriber#onNext
rx.internal.operators.OperatorWindowWithTime.ExactSubscriber#queue的add方法
rx.internal.operators.OperatorPublish.InnerProducer#produced
com.netflix.hystrix.metric.HystrixThreadPoolCompletionStream#write
com.netflix.hystrix.Hystrix#startCurrentThreadExecutingCommand的rx.functions.Action0#call
com.netflix.hystrix.Hystrix.ConcurrentStack#pop

传给Subscriber的subscriber的onCompleted方法（rx.observers.Subscribers#wrap方法创建的）

传给Subscriber的subscriber的onCompleted方法（rx.observers.Subscribers#wrap方法接收到的，rx.internal.operators.OnSubscribeDoOnEach.DoOnEachSubscriber#onCompleted）

调用rx.internal.util.ActionObserver#onCompleted
调用com/netflix/hystrix/AbstractCommand.java:444的fireOnCompletedHook的call方法
调用com.netflix.hystrix.AbstractCommand.ExecutionHookDeprecationWrapper#onSuccess

传给Subscriber的subscriber的onCompleted方法（rx.observers.Subscribers#wrap方法创建的）

传给Subscriber的subscriber的onCompleted方法（rx.observers.Subscribers#wrap方法接收到的，rx.internal.operators.OperatorSingle.ParentSubscriber#onCompleted）

创建rx.internal.producers.SingleProducer#SingleProducer
调用rx.Subscriber#setProducer
将producer下传给Subscriber的subscriber
调用rx.internal.producers.SingleProducer#request
调用rx.observers.SafeSubscriber#onNext
rx.internal.operators.BlockingOperatorToFuture#toFuture里创建的Subscriber的rx.Subscriber#onNext，设置toFuture的创建的临时变量。

rx.observers.SafeSubscriber#onCompleted
rx.internal.operators.BlockingOperatorToFuture#toFuture里创建的Subscriber的rx.Subscriber#onCompleted，toFuture的创建的临时变量finished减去1。

回退到rx.internal.operators.OperatorSubscribeOn#call的rx.Subscriber#onCompleted

com.netflix.hystrix.strategy.concurrency.HystrixContextScheduler.HystrixContextSchedulerWorker#unsubscribe
com.netflix.hystrix.strategy.concurrency.HystrixContextScheduler.ThreadPoolWorker#unsubscribe
rx.subscriptions.CompositeSubscription#unsubscribe

回退到线程正常退出