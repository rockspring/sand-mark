org/apache/lucene/search/MultiCollector.java
```
@Override
public void collect(int doc) throws IOException {
  final LeafCollector[] collectors = this.collectors;
  int numCollectors = this.numCollectors;
  for (int i = 0; i < numCollectors; ) {
    final LeafCollector collector = collectors[i];
    try {
      collector.collect(doc);
      ++i;
    } catch (CollectionTerminatedException e) {
      removeCollector(i);
      numCollectors = this.numCollectors;
      if (numCollectors == 0) {
        throw new CollectionTerminatedException();
      }
    }
  }
}
```

# 索引写入时如何创建docvalues字段

```
java.lang.Thread.State: RUNNABLE
	  at org.apache.lucene.document.SortedSetDocValuesField.<init>(SortedSetDocValuesField.java:60)
	  at org.elasticsearch.index.mapper.KeywordFieldMapper.parseCreateField(KeywordFieldMapper.java:266)
	  at org.elasticsearch.index.mapper.FieldMapper.parse(FieldMapper.java:286)
	  at org.elasticsearch.index.mapper.DocumentParser.parseObjectOrField(DocumentParser.java:438)
	  at org.elasticsearch.index.mapper.DocumentParser.parseValue(DocumentParser.java:564)
	  at org.elasticsearch.index.mapper.DocumentParser.innerParseObject(DocumentParser.java:384)
	  at org.elasticsearch.index.mapper.DocumentParser.parseObjectOrNested(DocumentParser.java:361)
	  at org.elasticsearch.index.mapper.DocumentParser.internalParseDocument(DocumentParser.java:93)
	  at org.elasticsearch.index.mapper.DocumentParser.parseDocument(DocumentParser.java:66)
	  at org.elasticsearch.index.mapper.DocumentMapper.parse(DocumentMapper.java:274)
	  at org.elasticsearch.index.shard.IndexShard.prepareIndex(IndexShard.java:516)
	  at org.elasticsearch.index.shard.IndexShard.prepareIndexOnPrimary(IndexShard.java:493)
	  at org.elasticsearch.action.index.TransportIndexAction.prepareIndexOperationOnPrimary(TransportIndexAction.java:174)
	  at org.elasticsearch.action.index.TransportIndexAction.executeIndexRequestOnPrimary(TransportIndexAction.java:184)
	  at org.elasticsearch.action.index.TransportIndexAction.onPrimaryShard(TransportIndexAction.java:144)
	  at org.elasticsearch.action.index.TransportIndexAction.onPrimaryShard(TransportIndexAction.java:63)
	  at org.elasticsearch.action.support.replication.TransportWriteAction.shardOperationOnPrimary(TransportWriteAction.java:78)
	  at org.elasticsearch.action.support.replication.TransportWriteAction.shardOperationOnPrimary(TransportWriteAction.java:50)
	  at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:902)
	  at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:872)
	  at org.elasticsearch.action.support.replication.ReplicationOperation.execute(ReplicationOperation.java:113)
	  at org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.onResponse(TransportReplicationAction.java:319)
	  at org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.onResponse(TransportReplicationAction.java:254)
	  at org.elasticsearch.action.support.replication.TransportReplicationAction$1.onResponse(TransportReplicationAction.java:838)
	  at org.elasticsearch.action.support.replication.TransportReplicationAction$1.onResponse(TransportReplicationAction.java:835)
	  at org.elasticsearch.index.shard.IndexShardOperationsLock.acquire(IndexShardOperationsLock.java:142)
	  at org.elasticsearch.index.shard.IndexShard.acquirePrimaryOperationLock(IndexShard.java:1624)
	  at org.elasticsearch.action.support.replication.TransportReplicationAction.acquirePrimaryShardReference(TransportReplicationAction.java:847)
	  at org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.doRun(TransportReplicationAction.java:271)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:250)
	  at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:242)
	  at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)
	  at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```


# 打开docvalues阅读器

```
java.lang.Thread.State: RUNNABLE
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer.<init>(Lucene54DocValuesProducer.java:104)
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesFormat.fieldsProducer(Lucene54DocValuesFormat.java:113)
	  at org.apache.lucene.codecs.perfield.PerFieldDocValuesFormat$FieldsReader.<init>(PerFieldDocValuesFormat.java:266)
	  at org.apache.lucene.codecs.perfield.PerFieldDocValuesFormat.fieldsProducer(PerFieldDocValuesFormat.java:355)
	  at org.apache.lucene.index.SegmentDocValues.newDocValuesProducer(SegmentDocValues.java:51)
	  at org.apache.lucene.index.SegmentDocValues.getDocValuesProducer(SegmentDocValues.java:67)
	  - locked <0x2311> (a org.apache.lucene.index.SegmentDocValues)
	  at org.apache.lucene.index.SegmentReader.initDocValuesProducer(SegmentReader.java:164)
	  at org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:90)
	  at org.apache.lucene.index.ReadersAndUpdates.getReader(ReadersAndUpdates.java:145)
	  at org.apache.lucene.index.ReadersAndUpdates.getReadOnlyClone(ReadersAndUpdates.java:197)
	  - locked <0x231b> (a org.apache.lucene.index.ReadersAndUpdates)
	  at org.apache.lucene.index.StandardDirectoryReader.open(StandardDirectoryReader.java:103)
	  at org.apache.lucene.index.IndexWriter.getReader(IndexWriter.java:460)
	  - locked <0x2331> (a java.lang.Object)
	  - locked <0x231e> (a org.apache.lucene.index.IndexWriter)
	  at org.apache.lucene.index.StandardDirectoryReader.doOpenFromWriter(StandardDirectoryReader.java:291)
	  at org.apache.lucene.index.StandardDirectoryReader.doOpenIfChanged(StandardDirectoryReader.java:266)
	  at org.apache.lucene.index.StandardDirectoryReader.doOpenIfChanged(StandardDirectoryReader.java:256)
	  at org.apache.lucene.index.FilterDirectoryReader.doOpenIfChanged(FilterDirectoryReader.java:104)
	  at org.apache.lucene.index.DirectoryReader.openIfChanged(DirectoryReader.java:140)
	  at org.apache.lucene.search.SearcherManager.refreshIfNeeded(SearcherManager.java:156)
	  at org.apache.lucene.search.SearcherManager.refreshIfNeeded(SearcherManager.java:58)
	  at org.apache.lucene.search.ReferenceManager.doMaybeRefresh(ReferenceManager.java:176)
	  at org.apache.lucene.search.ReferenceManager.maybeRefreshBlocking(ReferenceManager.java:253)
	  at org.elasticsearch.index.engine.InternalEngine.refresh(InternalEngine.java:622)
	  at org.elasticsearch.index.shard.IndexShard.refresh(IndexShard.java:612)
	  at org.elasticsearch.index.IndexService.maybeRefreshEngine(IndexService.java:732)
	  at org.elasticsearch.index.IndexService.access$400(IndexService.java:97)
	  at org.elasticsearch.index.IndexService$AsyncRefreshTask.runInternal(IndexService.java:874)
	  at org.elasticsearch.index.IndexService$BaseAsyncTask.run(IndexService.java:785)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:444)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```

# 读取docvalue数据中binary部分

```
java.lang.Thread.State: RUNNABLE
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer.getFixedBinary(Lucene54DocValuesProducer.java:700)
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer.getBinary(Lucene54DocValuesProducer.java:689)
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer.getSorted(Lucene54DocValuesProducer.java:792)
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer.getSortedSet(Lucene54DocValuesProducer.java:913)
	  at org.apache.lucene.codecs.perfield.PerFieldDocValuesFormat$FieldsReader.getSortedSet(PerFieldDocValuesFormat.java:307)
	  at org.apache.lucene.index.CodecReader.getSortedSetDocValues(CodecReader.java:260)
	  at org.apache.lucene.index.FilterLeafReader.getSortedSetDocValues(FilterLeafReader.java:460)
	  at org.apache.lucene.index.DocValues.getSortedSet(DocValues.java:302)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVBytesAtomicFieldData.getOrdinalsValues(SortedSetDVBytesAtomicFieldData.java:49)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals$FieldData.globalOrdinalsValues(ValuesSource.java:152)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals.globalMaxOrd(ValuesSource.java:123)
	  at org.elasticsearch.search.aggregations.bucket.terms.TermsAggregatorFactory.doCreateInternal(TermsAggregatorFactory.java:120)
	  at org.elasticsearch.search.aggregations.support.ValuesSourceAggregatorFactory.createInternal(ValuesSourceAggregatorFactory.java:55)
	  at org.elasticsearch.search.aggregations.AggregatorFactory.create(AggregatorFactory.java:225)
	  at org.elasticsearch.search.aggregations.AggregatorFactories.createTopLevelAggregators(AggregatorFactories.java:102)
	  at org.elasticsearch.search.aggregations.AggregationPhase.preProcess(AggregationPhase.java:61)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:104)
	  at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:237)
	  at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:347)
	  at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$664(SearchTransportService.java:291)
	  at org.elasticsearch.action.search.SearchTransportService$$Lambda$1017.1465691120.messageReceived(Unknown Source:-1)
	  at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)
	  at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)
	  at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```

# 读取docvalues数据的number部分

```
java.lang.Thread.State: RUNNABLE
	  at org.apache.lucene.store.IndexInput.randomAccessSlice(IndexInput.java:122)
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer.getNumeric(Lucene54DocValuesProducer.java:495)
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer.getSorted(Lucene54DocValuesProducer.java:794)
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer.getSortedSet(Lucene54DocValuesProducer.java:913)
	  at org.apache.lucene.codecs.perfield.PerFieldDocValuesFormat$FieldsReader.getSortedSet(PerFieldDocValuesFormat.java:307)
	  at org.apache.lucene.index.CodecReader.getSortedSetDocValues(CodecReader.java:260)
	  at org.apache.lucene.index.FilterLeafReader.getSortedSetDocValues(FilterLeafReader.java:460)
	  at org.apache.lucene.index.DocValues.getSortedSet(DocValues.java:302)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVBytesAtomicFieldData.getOrdinalsValues(SortedSetDVBytesAtomicFieldData.java:49)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals$FieldData.globalOrdinalsValues(ValuesSource.java:152)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals.globalMaxOrd(ValuesSource.java:123)
	  at org.elasticsearch.search.aggregations.bucket.terms.TermsAggregatorFactory.doCreateInternal(TermsAggregatorFactory.java:120)
	  at org.elasticsearch.search.aggregations.support.ValuesSourceAggregatorFactory.createInternal(ValuesSourceAggregatorFactory.java:55)
	  at org.elasticsearch.search.aggregations.AggregatorFactory.create(AggregatorFactory.java:225)
	  at org.elasticsearch.search.aggregations.AggregatorFactories.createTopLevelAggregators(AggregatorFactories.java:102)
	  at org.elasticsearch.search.aggregations.AggregationPhase.preProcess(AggregationPhase.java:61)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:104)
	  at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:237)
	  at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:347)
	  at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$664(SearchTransportService.java:291)
	  at org.elasticsearch.action.search.SearchTransportService$$Lambda$1017.1465691120.messageReceived(Unknown Source:-1)
	  at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)
	  at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)
	  at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```


```
java.lang.Thread.State: RUNNABLE
	  at org.elasticsearch.search.DefaultSearchContext.queryCollectors(DefaultSearchContext.java:803)
	  at org.elasticsearch.search.aggregations.AggregationPhase.preProcess(AggregationPhase.java:76)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:104)
	  at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:237)
	  at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:347)
	  at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$664(SearchTransportService.java:291)
	  at org.elasticsearch.action.search.SearchTransportService$$Lambda$1017.1465691120.messageReceived(Unknown Source:-1)
	  at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)
	  at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)
	  at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```

# 创建叶子节点的收集器

```
java.lang.Thread.State: RUNNABLE
	  at org.elasticsearch.search.aggregations.LeafBucketCollectorBase.<init>(LeafBucketCollectorBase.java:42)
	  at org.elasticsearch.search.aggregations.bucket.terms.GlobalOrdinalsStringTermsAggregator$2.<init>(GlobalOrdinalsStringTermsAggregator.java:120)
	  at org.elasticsearch.search.aggregations.bucket.terms.GlobalOrdinalsStringTermsAggregator.newCollector(GlobalOrdinalsStringTermsAggregator.java:120)
	  at org.elasticsearch.search.aggregations.bucket.terms.GlobalOrdinalsStringTermsAggregator.getLeafCollector(GlobalOrdinalsStringTermsAggregator.java:102)
	  at org.elasticsearch.search.aggregations.AggregatorBase.getLeafCollector(AggregatorBase.java:149)
	  at org.elasticsearch.search.aggregations.AggregatorBase.getLeafCollector(AggregatorBase.java:41)
	  at org.apache.lucene.search.MultiCollector.getLeafCollector(MultiCollector.java:121)
	  at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:660)
	  at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:473)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:370)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:106)
	  at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:237)
	  at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:347)
	  at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$664(SearchTransportService.java:291)
	  at org.elasticsearch.action.search.SearchTransportService$$Lambda$1017.1465691120.messageReceived(Unknown Source:-1)
	  at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)
	  at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)
	  at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)

```

加载一个文档的字段数据

```
java.lang.Thread.State: RUNNABLE
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVBytesAtomicFieldData.<init>(SortedSetDVBytesAtomicFieldData.java:41)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.load(SortedSetDVOrdinalsIndexFieldData.java:58)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.load(SortedSetDVOrdinalsIndexFieldData.java:38)
	  at org.elasticsearch.index.fielddata.ordinals.GlobalOrdinalsBuilder.build(GlobalOrdinalsBuilder.java:58)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.localGlobalDirect(SortedSetDVOrdinalsIndexFieldData.java:103)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.localGlobalDirect(SortedSetDVOrdinalsIndexFieldData.java:38)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.lambda$load$368(IndicesFieldDataCache.java:159)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache$$Lambda$1348.478240588.load(Unknown Source:-1)
	  at org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java:385)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.load(IndicesFieldDataCache.java:154)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.loadGlobal(SortedSetDVOrdinalsIndexFieldData.java:91)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals$FieldData.globalOrdinalsValues(ValuesSource.java:150)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals.globalMaxOrd(ValuesSource.java:123)
	  at org.elasticsearch.search.aggregations.bucket.terms.TermsAggregatorFactory.doCreateInternal(TermsAggregatorFactory.java:120)
	  at org.elasticsearch.search.aggregations.support.ValuesSourceAggregatorFactory.createInternal(ValuesSourceAggregatorFactory.java:55)
	  at org.elasticsearch.search.aggregations.AggregatorFactory.create(AggregatorFactory.java:225)
	  at org.elasticsearch.search.aggregations.AggregatorFactories.createTopLevelAggregators(AggregatorFactories.java:102)
	  at org.elasticsearch.search.aggregations.AggregationPhase.preProcess(AggregationPhase.java:61)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:104)
	  at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:237)
	  at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:347)
	  at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$664(SearchTransportService.java:291)
	  at org.elasticsearch.action.search.SearchTransportService$$Lambda$1017.1465691120.messageReceived(Unknown Source:-1)
	  at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)
	  at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)
	  at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```

```
java.lang.Thread.State: RUNNABLE
	  at org.apache.lucene.index.BinaryDocValues.<init>(BinaryDocValues.java:29)
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer$LongBinaryDocValues.<init>(Lucene54DocValuesProducer.java:1194)
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer$5.<init>(Lucene54DocValuesProducer.java:706)
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer.getFixedBinary(Lucene54DocValuesProducer.java:706)
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer.getBinary(Lucene54DocValuesProducer.java:689)
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer.getSorted(Lucene54DocValuesProducer.java:792)
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer.getSortedSet(Lucene54DocValuesProducer.java:913)
	  at org.apache.lucene.codecs.perfield.PerFieldDocValuesFormat$FieldsReader.getSortedSet(PerFieldDocValuesFormat.java:307)
	  at org.apache.lucene.index.CodecReader.getSortedSetDocValues(CodecReader.java:260)
	  at org.apache.lucene.index.FilterLeafReader.getSortedSetDocValues(FilterLeafReader.java:460)
	  at org.apache.lucene.index.DocValues.getSortedSet(DocValues.java:302)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVBytesAtomicFieldData.getOrdinalsValues(SortedSetDVBytesAtomicFieldData.java:49)
	  at org.elasticsearch.index.fielddata.ordinals.GlobalOrdinalsBuilder.build(GlobalOrdinalsBuilder.java:59)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.localGlobalDirect(SortedSetDVOrdinalsIndexFieldData.java:103)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.localGlobalDirect(SortedSetDVOrdinalsIndexFieldData.java:38)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.lambda$load$368(IndicesFieldDataCache.java:159)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache$$Lambda$1348.478240588.load(Unknown Source:-1)
	  at org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java:385)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.load(IndicesFieldDataCache.java:154)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.loadGlobal(SortedSetDVOrdinalsIndexFieldData.java:91)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals$FieldData.globalOrdinalsValues(ValuesSource.java:150)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals.globalMaxOrd(ValuesSource.java:123)
	  at org.elasticsearch.search.aggregations.bucket.terms.TermsAggregatorFactory.doCreateInternal(TermsAggregatorFactory.java:120)
	  at org.elasticsearch.search.aggregations.support.ValuesSourceAggregatorFactory.createInternal(ValuesSourceAggregatorFactory.java:55)
	  at org.elasticsearch.search.aggregations.AggregatorFactory.create(AggregatorFactory.java:225)
	  at org.elasticsearch.search.aggregations.AggregatorFactories.createTopLevelAggregators(AggregatorFactories.java:102)
	  at org.elasticsearch.search.aggregations.AggregationPhase.preProcess(AggregationPhase.java:61)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:104)
	  at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:237)
	  at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:347)
	  at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$664(SearchTransportService.java:291)
	  at org.elasticsearch.action.search.SearchTransportService$$Lambda$1017.1465691120.messageReceived(Unknown Source:-1)
	  at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)
	  at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)
	  at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```

```
java.lang.Thread.State: RUNNABLE
	  at org.apache.lucene.index.MultiDocValues$OrdinalMap.<init>(MultiDocValues.java:552)
	  at org.apache.lucene.index.MultiDocValues$OrdinalMap.build(MultiDocValues.java:484)
	  at org.apache.lucene.index.MultiDocValues$OrdinalMap.build(MultiDocValues.java:463)
	  at org.elasticsearch.index.fielddata.ordinals.GlobalOrdinalsBuilder.build(GlobalOrdinalsBuilder.java:61)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.localGlobalDirect(SortedSetDVOrdinalsIndexFieldData.java:103)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.localGlobalDirect(SortedSetDVOrdinalsIndexFieldData.java:38)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.lambda$load$368(IndicesFieldDataCache.java:159)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache$$Lambda$1348.478240588.load(Unknown Source:-1)
	  at org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java:385)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.load(IndicesFieldDataCache.java:154)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.loadGlobal(SortedSetDVOrdinalsIndexFieldData.java:91)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals$FieldData.globalOrdinalsValues(ValuesSource.java:150)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals.globalMaxOrd(ValuesSource.java:123)
	  at org.elasticsearch.search.aggregations.bucket.terms.TermsAggregatorFactory.doCreateInternal(TermsAggregatorFactory.java:120)
	  at org.elasticsearch.search.aggregations.support.ValuesSourceAggregatorFactory.createInternal(ValuesSourceAggregatorFactory.java:55)
	  at org.elasticsearch.search.aggregations.AggregatorFactory.create(AggregatorFactory.java:225)
	  at org.elasticsearch.search.aggregations.AggregatorFactories.createTopLevelAggregators(AggregatorFactories.java:102)
	  at org.elasticsearch.search.aggregations.AggregationPhase.preProcess(AggregationPhase.java:61)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:104)
	  at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:237)
	  at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:347)
	  at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$664(SearchTransportService.java:291)
	  at org.elasticsearch.action.search.SearchTransportService$$Lambda$1017.1465691120.messageReceived(Unknown Source:-1)
	  at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)
	  at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)
	  at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```

```
java.lang.Thread.State: RUNNABLE
	  at org.apache.lucene.search.TopScoreDocCollector$SimpleTopScoreDocCollector$1.collect(TopScoreDocCollector.java:64)
	  at org.apache.lucene.search.MultiCollector$MultiLeafCollector.collect(MultiCollector.java:174)
	  at org.apache.lucene.search.FilterLeafCollector.collect(FilterLeafCollector.java:43)
	  at org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:221)
	  at org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:172)
	  at org.apache.lucene.search.ConstantScoreQuery$ConstantBulkScorer.score(ConstantScoreQuery.java:84)
	  at org.apache.lucene.search.BulkScorer.score(BulkScorer.java:39)
	  at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:669)
	  at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:473)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:370)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:106)
	  at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:237)
	  at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:347)
	  at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$664(SearchTransportService.java:291)
	  at org.elasticsearch.action.search.SearchTransportService$$Lambda$1017.1465691120.messageReceived(Unknown Source:-1)
	  at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)
	  at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)
	  at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```

```
java.lang.Thread.State: RUNNABLE
	  at org.elasticsearch.common.util.BigArrays$IntArrayWrapper.increment(BigArrays.java:198)
	  at org.elasticsearch.search.aggregations.bucket.BucketsAggregator.collectExistingBucket(BucketsAggregator.java:79)
	  at org.elasticsearch.search.aggregations.bucket.terms.GlobalOrdinalsStringTermsAggregator$1.collect(GlobalOrdinalsStringTermsAggregator.java:115)
	  at org.elasticsearch.search.aggregations.LeafBucketCollector.collect(LeafBucketCollector.java:82)
	  at org.apache.lucene.search.MultiCollector$MultiLeafCollector.collect(MultiCollector.java:174)
	  at org.apache.lucene.search.FilterLeafCollector.collect(FilterLeafCollector.java:43)
	  at org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:221)
	  at org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:172)
	  at org.apache.lucene.search.ConstantScoreQuery$ConstantBulkScorer.score(ConstantScoreQuery.java:84)
	  at org.apache.lucene.search.BulkScorer.score(BulkScorer.java:39)
	  at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:669)
	  at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:473)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:370)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:106)
	  at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:237)
	  at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:347)
	  at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$664(SearchTransportService.java:291)
	  at org.elasticsearch.action.search.SearchTransportService$$Lambda$1017.1465691120.messageReceived(Unknown Source:-1)
	  at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)
	  at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)
	  at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```


```
java.lang.Thread.State: RUNNABLE
	  at org.elasticsearch.search.aggregations.bucket.terms.InternalTerms$Bucket.<init>(InternalTerms.java:66)
	  at org.elasticsearch.search.aggregations.bucket.terms.GlobalOrdinalsStringTermsAggregator$OrdBucket.<init>(GlobalOrdinalsStringTermsAggregator.java:215)
	  at org.elasticsearch.search.aggregations.bucket.terms.GlobalOrdinalsStringTermsAggregator.buildAggregation(GlobalOrdinalsStringTermsAggregator.java:159)
	  at org.elasticsearch.search.aggregations.AggregationPhase.execute(AggregationPhase.java:143)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:112)
	  at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:237)
	  at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:347)
	  at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$664(SearchTransportService.java:291)
	  at org.elasticsearch.action.search.SearchTransportService$$Lambda$1017.1465691120.messageReceived(Unknown Source:-1)
	  at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)
	  at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)
	  at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```



# 聚合查询时

## 初始化每个段的field数据

org/elasticsearch/index/fielddata/ordinals/GlobalOrdinalsBuilder.java
```
for (int i = 0; i < indexReader.leaves().size(); ++i) {
    atomicFD[i] = indexFieldData.load(indexReader.leaves().get(i));
    subs[i] = atomicFD[i].getOrdinalsValues();
}
```

## 加载每个段的field数据

```
java.lang.Thread.State: RUNNABLE
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVBytesAtomicFieldData.<init>(SortedSetDVBytesAtomicFieldData.java:42)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.load(SortedSetDVOrdinalsIndexFieldData.java:58)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.load(SortedSetDVOrdinalsIndexFieldData.java:38)
	  at org.elasticsearch.index.fielddata.ordinals.GlobalOrdinalsBuilder.build(GlobalOrdinalsBuilder.java:58)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.localGlobalDirect(SortedSetDVOrdinalsIndexFieldData.java:103)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.localGlobalDirect(SortedSetDVOrdinalsIndexFieldData.java:38)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.lambda$load$368(IndicesFieldDataCache.java:159)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache$$Lambda$1314.1181970347.load(Unknown Source:-1)
	  at org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java:385)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.load(IndicesFieldDataCache.java:154)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.loadGlobal(SortedSetDVOrdinalsIndexFieldData.java:91)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals$FieldData.globalOrdinalsValues(ValuesSource.java:150)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals.globalMaxOrd(ValuesSource.java:123)
	  at org.elasticsearch.search.aggregations.bucket.terms.TermsAggregatorFactory.doCreateInternal(TermsAggregatorFactory.java:120)
	  at org.elasticsearch.search.aggregations.support.ValuesSourceAggregatorFactory.createInternal(ValuesSourceAggregatorFactory.java:55)
	  at org.elasticsearch.search.aggregations.AggregatorFactory.create(AggregatorFactory.java:225)
	  at org.elasticsearch.search.aggregations.AggregatorFactories.createTopLevelAggregators(AggregatorFactories.java:102)
	  at org.elasticsearch.search.aggregations.AggregationPhase.preProcess(AggregationPhase.java:61)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:104)
	  at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:237)
	  at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:347)
	  at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$664(SearchTransportService.java:291)
	  at org.elasticsearch.action.search.SearchTransportService$$Lambda$1017.790689709.messageReceived(Unknown Source:-1)
	  at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)
	  at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)
	  at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```


# 获得 RandomAccessOrds(包含SortedSetDocValues）

```
java.lang.Thread.State: RUNNABLE
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer.getSorted(Lucene54DocValuesProducer.java:791)
	  at org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer.getSortedSet(Lucene54DocValuesProducer.java:913)
	  at org.apache.lucene.codecs.perfield.PerFieldDocValuesFormat$FieldsReader.getSortedSet(PerFieldDocValuesFormat.java:307)
	  at org.apache.lucene.index.CodecReader.getSortedSetDocValues(CodecReader.java:260)
	  at org.apache.lucene.index.FilterLeafReader.getSortedSetDocValues(FilterLeafReader.java:460)
	  at org.apache.lucene.index.DocValues.getSortedSet(DocValues.java:302)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVBytesAtomicFieldData.getOrdinalsValues(SortedSetDVBytesAtomicFieldData.java:49)
	  at org.elasticsearch.index.fielddata.ordinals.GlobalOrdinalsBuilder.build(GlobalOrdinalsBuilder.java:59)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.localGlobalDirect(SortedSetDVOrdinalsIndexFieldData.java:103)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.localGlobalDirect(SortedSetDVOrdinalsIndexFieldData.java:38)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.lambda$load$368(IndicesFieldDataCache.java:159)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache$$Lambda$1314.1181970347.load(Unknown Source:-1)
	  at org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java:385)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.load(IndicesFieldDataCache.java:154)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.loadGlobal(SortedSetDVOrdinalsIndexFieldData.java:91)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals$FieldData.globalOrdinalsValues(ValuesSource.java:150)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals.globalMaxOrd(ValuesSource.java:123)
	  at org.elasticsearch.search.aggregations.bucket.terms.TermsAggregatorFactory.doCreateInternal(TermsAggregatorFactory.java:120)
	  at org.elasticsearch.search.aggregations.support.ValuesSourceAggregatorFactory.createInternal(ValuesSourceAggregatorFactory.java:55)
	  at org.elasticsearch.search.aggregations.AggregatorFactory.create(AggregatorFactory.java:225)
	  at org.elasticsearch.search.aggregations.AggregatorFactories.createTopLevelAggregators(AggregatorFactories.java:102)
	  at org.elasticsearch.search.aggregations.AggregationPhase.preProcess(AggregationPhase.java:61)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:104)
	  at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:237)
	  at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:347)
	  at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$664(SearchTransportService.java:291)
	  at org.elasticsearch.action.search.SearchTransportService$$Lambda$1017.790689709.messageReceived(Unknown Source:-1)
	  at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)
	  at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)
	  at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```


## 合并所有段的数据，构造searcher范围内的全局OrdinalMap

```
java.lang.Thread.State: RUNNABLE
	  at org.apache.lucene.index.MultiDocValues$OrdinalMap.<init>(MultiDocValues.java:531)
	  at org.apache.lucene.index.MultiDocValues$OrdinalMap.build(MultiDocValues.java:484)
	  at org.apache.lucene.index.MultiDocValues$OrdinalMap.build(MultiDocValues.java:463)
	  at org.elasticsearch.index.fielddata.ordinals.GlobalOrdinalsBuilder.build(GlobalOrdinalsBuilder.java:61)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.localGlobalDirect(SortedSetDVOrdinalsIndexFieldData.java:103)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.localGlobalDirect(SortedSetDVOrdinalsIndexFieldData.java:38)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.lambda$load$368(IndicesFieldDataCache.java:159)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache$$Lambda$1314.1181970347.load(Unknown Source:-1)
	  at org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java:385)
	  at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.load(IndicesFieldDataCache.java:154)
	  at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.loadGlobal(SortedSetDVOrdinalsIndexFieldData.java:91)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals$FieldData.globalOrdinalsValues(ValuesSource.java:150)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals.globalMaxOrd(ValuesSource.java:123)
	  at org.elasticsearch.search.aggregations.bucket.terms.TermsAggregatorFactory.doCreateInternal(TermsAggregatorFactory.java:120)
	  at org.elasticsearch.search.aggregations.support.ValuesSourceAggregatorFactory.createInternal(ValuesSourceAggregatorFactory.java:55)
	  at org.elasticsearch.search.aggregations.AggregatorFactory.create(AggregatorFactory.java:225)
	  at org.elasticsearch.search.aggregations.AggregatorFactories.createTopLevelAggregators(AggregatorFactories.java:102)
	  at org.elasticsearch.search.aggregations.AggregationPhase.preProcess(AggregationPhase.java:61)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:104)
	  at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:237)
	  at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:347)
	  at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$664(SearchTransportService.java:291)
	  at org.elasticsearch.action.search.SearchTransportService$$Lambda$1017.790689709.messageReceived(Unknown Source:-1)
	  at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)
	  at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)
	  at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```

```
java.lang.Thread.State: RUNNABLE
	  at org.elasticsearch.index.fielddata.ordinals.GlobalOrdinalMapping.<init>(GlobalOrdinalMapping.java:39)
	  at org.elasticsearch.index.fielddata.ordinals.InternalGlobalOrdinalsIndexFieldData$Atomic.getOrdinalsValues(InternalGlobalOrdinalsIndexFieldData.java:74)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals$FieldData.globalOrdinalsValues(ValuesSource.java:152)
	  at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes$WithOrdinals.globalMaxOrd(ValuesSource.java:123)
	  at org.elasticsearch.search.aggregations.bucket.terms.TermsAggregatorFactory.doCreateInternal(TermsAggregatorFactory.java:120)
	  at org.elasticsearch.search.aggregations.support.ValuesSourceAggregatorFactory.createInternal(ValuesSourceAggregatorFactory.java:55)
	  at org.elasticsearch.search.aggregations.AggregatorFactory.create(AggregatorFactory.java:225)
	  at org.elasticsearch.search.aggregations.AggregatorFactories.createTopLevelAggregators(AggregatorFactories.java:102)
	  at org.elasticsearch.search.aggregations.AggregationPhase.preProcess(AggregationPhase.java:61)
	  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:104)
	  at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:237)
	  at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:347)
	  at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$664(SearchTransportService.java:291)
	  at org.elasticsearch.action.search.SearchTransportService$$Lambda$1017.790689709.messageReceived(Unknown Source:-1)
	  at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)
	  at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)
	  at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```


## 如何合并多个searcher的聚合结果

这个时候bucket的key就是实际的字段值，使用java的map数据结构

```
for (B bucket : terms.getBucketsInternal()) {
    bucket.docCountError = thisAggDocCountError;
    List<B> bucketList = buckets.get(bucket.getKey());
    if (bucketList == null) {
        bucketList = new ArrayList<>();
        buckets.put(bucket.getKey(), bucketList);
    }
    bucketList.add(bucket);
}
```

```
java.lang.Thread.State: RUNNABLE
	  at org.elasticsearch.search.aggregations.bucket.terms.InternalTerms.doReduce(InternalTerms.java:184)
	  at org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:142)
	  at org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:158)
	  at org.elasticsearch.action.search.SearchPhaseController.merge(SearchPhaseController.java:493)
	  at org.elasticsearch.action.search.SearchQueryAndFetchAsyncAction$1.doRun(SearchQueryAndFetchAsyncAction.java:63)
	  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504)
	  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
```
