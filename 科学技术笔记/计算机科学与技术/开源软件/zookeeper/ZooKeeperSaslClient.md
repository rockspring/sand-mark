
ClientCnxn循环运行时，即执行run方法


ClientCnxn的startConnect方法里判断是否启用ZooKeeperSaslClient，如果启用了则创建ZooKeeperSaslClient实例。是否启用的判断是在ZooKeeperSaslClient的isEnabled方法里执行。调用ClientCnxnSocket的connect方法建立socket连接。


如何判断是否启用ZooKeeperSaslClient？如何确定创建ZooKeeperSaslClient时需要的参数？

这个系统属性zookeeper.sasl.client决定是否启用ZooKeeperSaslClient。系统属性zookeeper.sasl.client的默认值为true，也就默认启动ZooKeeperSaslClient。如果启用了ZooKeeperSaslClient，通过系统属性zookeeper.sasl.client.username获取principalUserName，系统属性zookeeper.sasl.client.username有一个默认值zookeeper。通过服务器的地址获取服务器的主机名hostname，比如在连接字符串中制定了服务器地址为127.0.0.1，获取的主机名为127.0.0.1。获取到principalUserName和hostname后，将这两部分通过“/”符号连接起来，得到principalUserName/hostname，比如zookeeper/127.0.0.1，我们称之为serverPrincipal。使用serverPrincipal创建ZooKeeperSaslClient。


ZooKeeperSaslClient的创建过程是什么？

ZooKeeperSaslClient有4个状态，初始状态为INITIAL。

ZooKeeperSaslClient的创建过程。通过系统属性zookeeper.sasl.clientconfig获得clientSection，默认值为Client。尝试读取JAAS配置文件jass.conf，从中获取clientSection的条目。如果获取结果为空，ZooKeeperSaslClient进入到FAILED状态。


clientSection条目为空时，通过系统属性zookeeper.sasl.clientconfig获得explicitClientSection，如果为空，用户可能不打算使用SASL。创建一条消息msg，内容为“Will not attempt to authenticate using SASL (unknown error)”，设置为ZooKeeperSaslClient的configStatus字段值。ZooKeeperSaslClient的isSASLConfigured字段值设置为false。


clientSection条目不为空，调用ZooKeeperSaslClient的createSaslClient方法创建SaslClient。需要传递两个参数，servicePrincipal为创建ZooKeeperSaslClient时传递过来的，clientSection为从zookeeper.sasl.clientconfig系统属性获的名称。


ClientCnxnSocket的实现类ClientCnxnSocketNIO的connect方法如何执行？

调用方法createSock创建一个非阻塞的socket对象。调用registerAndConnect方法。注册OP_CONNECT事件到Selector中，设置注册成功的sockKey，ClientCnxnSocketNIO根据是否已经有注册的sockKey判断是否已经发起连接，真正的连接并没有建立。调用socket的connect方法发起连接。因为是非阻塞模式，connect立即返回，返回结果为false。

ClientCnxn的线程循环执行IO操作？

调用ClientCnxnSocketNIO的doTransport方法

从selector中选择已经发生的IO事件。

如果发生了OP_CONNECT，如果已经完成socket连接建立，调用SendThread的primeConnection方法。

