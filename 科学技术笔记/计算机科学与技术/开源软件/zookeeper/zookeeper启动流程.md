读取配置文件并解析配置项

DatadirCleanupManager根据配置设置定时器的任务PurgeTask

保留多少分快照？多长时间清理一次？

QuorumPeerMain.runFromConfig

监听客户端连接的端口2181

NIOServerCnxnFactory

Selector复用IO

创建一个独立的线程NIOServerCxn.Factory，但是不启动线程。



调用QuorumPeer的loadDataBase加载数据库

准备客户端连接，打开端口2181

调用NIOServerCnxnFactory.run启动IO事件循环，不断地调用Selector的select方法看有没有IO事件，然后处理IO事件

这个时候可以接受网络请求了，但是ZooKeeperServer还没启动，不能处理直接的客户端请求，NIOServerCnxn会持有ZooKeeperServer的实例
2181端口已经打开

启动选举，调用QuorumPeer的startLeaderElection

QuorumCnxManager是一个领导者选举的连接管理器

创建一个QuorumCnxManager，有一个监听器Listener，它是一个独立的线程


Listener打开选举端口，启动循环，接受连接

创建FastLeaderElection

FastLeaderElection创建一个Messenger

Messenger创建两个线程WorkerSender和WorkerReceiver

启动QuorumPeer线程，启动一个循环

QuorumPeer线程获取自己节点的状态，LOOKING、OBSERVING、FOLLOWING、LEADING，根据不同的状态执行不同的操作


QuorumServer这个类里有两个地址，addr为领导者的地址，electionAddr为选举投票的地址，只有领导者会打开addr地址，监听follower的请求

startLeaderElection方法中把的addr地址设置为myQuorumAddr

成为leader后，打开端口myQuorumAddr，如2888

leader使用LearnerCnxAcceptor，是一个线程，启动这个线程




QuorumPeer投票结束后，进入FOLLOWING状态，创建follower对象，调用它的followLeader方法，连接leader后进入包处理循环，包最终交给FollowerZooKeeperServer



zookeeper的leader在2181端口的处理

处理器链

PrepRequestProcessor -> ProposalRequestProcessor -> CommitProcessor -> Leader.ToBeAppliedRequestProcessor -> FinalRequestProcessor

NIOServerCnxn处理网络包，交给LeaderZooKeeperServer处理

LeaderZooKeeperServer的processPacket方法

processPacket方法调用ZooKeeperServer的submitRequest方法

ZooKeeperServer的submitRequest方法调用PrepRequestProcessor（第一个处理器）的processRequest方法

将请求写入到PrepRequestProcessor的队列submittedRequests



PrepRequestProcessor有一个处理循环

PrepRequestProcessor的方法pRequest

PrepRequestProcessor的方法pRequest调用PrepRequestProcessor的pRequest2Txn方法

PrepRequestProcessor的pRequest2Txn方法创建CreateTxn对象

PrepRequestProcessor的pRequest2Txn方法调用ProposalRequestProcessor的processRequest

ProposalRequestProcessor的processRequest调用CommitProcessor的processRequest方法

CommitProcessor的processRequest方法将请求写入queuedRequests队列


ProposalRequestProcessor的processRequest方法调用Leader的propose方法

Leader的propose方法调用Leader的sendPacket

Leader的sendPacket方法中，对每一个follower，调用对应的LearnerHandler的queuePacket方法

LearnerHandler的queuePacket方法将QuorumPacket放入LearnerHandler的队列queuedPackets

ProposalRequestProcessor的processRequest方法调用SyncRequestProcessor的processRequest

SyncRequestProcessor的processRequest将Request方法自己的队列queuedRequests

CommitProcessor有一个处理循环

读取CommitProcessor的queuedRequests队列，将请求转入到toProcess，调用Leader#ToBeAppliedRequestProcessor的processRequest方法

Leader#ToBeAppliedRequestProcessor的processRequest方法调用FinalRequestProcessor的processRequest方法

FinalRequestProcessor的processRequest方法调用LeaderZooKeeperServer的processTxn方法

LeaderZooKeeperServer的processTxn方法调用数据库引擎ZKDatabase的processTxn方法

FinalRequestProcessor的processRequest方法调用引擎的addCommittedProposal方法将请求加到提交日志里

