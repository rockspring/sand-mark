ConfigFile --> javax.security.auth.login.Configuration

void init(URL url)方法中读取系统属性java.security.auth.login.config得到配置文件路径jaas.conf

```
Server {
       com.sun.security.auth.module.Krb5LoginModule required
       useKeyTab=true
       keyTab="/home/ec2-user/zookeeper/conf/zookeeper.keytab"
       storeKey=true
       useTicketCache=false
       principal="zookeeper/localhost";
};
Client {
       com.sun.security.auth.module.Krb5LoginModule required
       useKeyTab=true
       keyTab="/home/ec2-user/zookeeper/conf/myzkclient.keytab"
       principal="myzkclient"
       useTicketCache=false
       debug=true;
};

```


## java的security代码解读

### Principal

代表任何实体，比如个体、公司、登陆唯一码

### KerberosPrincipal

Kerberos中的实体，字符串表示比如krbtgt/58OS.ORG@58OS.ORG，krbtgt是系统创建的用户，@后面的东西为realm

### KerberosTicket

```
byte[] asn1Encoding,
KerberosPrincipal client,
KerberosPrincipal server,
byte[] sessionKey,
int keyType,
boolean[] flags,
Date authTime,
Date startTime,
Date endTime,
Date renewTill,
InetAddress[] clientAddresses
```

使用从KDC获得凭证信息credentials创建

sessionKey the raw bytes for the session key that must be used to encrypt the authenticator that will be sent to the server

既适用于ticket granting tickets，也适用于regular service tickets

All Kerberos JAAS login modules that authenticate a user to a KDC should use this class.

### Subject

represents a grouping of related information for a single entity, such as a person.




zookeeper有一个系统属性zookeeper.sasl.serverconfig可以指定登陆上下文的名称，默认为Server，关联jaas.conf中的Server块

## configureSaslLogin方法执行流程

1，获取登陆上下文的名称，默认为Server

2，对应jass.conf的内容对应javax.security.auth.login.Configuration类的实例，用第一步中的名称获取javax.security.auth.loginAppConfigurationEntry类的实例

3，检验jass.conf文件内容是否符合要求

4，创建一个SaslServerCallbackHandler实例，传入参数为javax.security.auth.login.Configuration类的实例

5，创建Login实例，传入参数为登陆上下文的名称和SaslServerCallbackHandler实例

6，启动Login里面的登陆线程

## Login构造函数执行流程

1 LoginContext login(final String loginContextName)

1.1 调用LoginContext构造函数

1.2 调用LoginContext的login方法

2 调用LoginContext的getSubject方法获取Subject

3 调用Subject的getPrivateCredentials方法获取私有凭证，并检查是否为kerberos票

4 从jaas.conf的配置实例Configuration获取一节的条目，读取每个条目，解析options，配置isUsingTicketCache、isUsingKeytab、keytabFile、principal等项目

5 创建线程定期刷新Ticket Granting Ticket (TGT)

## 定期刷新Ticket Granting Ticket（TGT）的线程执行流程

1 获取TGT，查看是否有krbtgt/[realm]@[realm]，比如krbtgt/58OS.ORG@58OS.ORG

2 如果未找到TGT，如果isUsingTicketCache为true，调用Linux命令```/usr/bin/kinit -R```

3 如果未找到TGT，但是isUsingTicketCache为false，调用reLogin方法重新登录一遍


## LoginModule如何登录

kerberos对应的实现类Krb5LoginModule

调用login方法

调用commit方法
